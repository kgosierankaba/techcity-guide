<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechCity Squad - Microsoft 365 Service Desk Solution</title>
    <style>
        :root {
            --primary: #0078d4;
            --secondary: #005a9e;
            --accent: #ffb900;
            --light: #f3f2f1;
            --dark: #323130;
            --success: #107c10;
            --warning: #d83b01;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        header p {
            opacity: 0.8;
            font-size: 1.1rem;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 0;
        }
        
        nav {
            background-color: var(--dark);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav .container {
            padding: 0.5rem 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        nav a {
            color: white;
            padding: 0.75rem 1rem;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 6px;
        }
        
        nav a:hover {
            background-color: var(--secondary);
            color: var(--accent);
        }

        section {
            padding: 4rem 0;
            border-bottom: 1px solid var(--light);
        }

        section h2 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--accent);
            padding-left: 1rem;
        }

        h3 {
            color: var(--secondary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.4rem;
        }

        ul, ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        code, pre {
            background-color: #e8e8e8;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
        }

        pre {
            padding: 1rem;
            overflow-x: auto;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-weight: 600;
        }

        .alert-warning {
            background-color: #fff4e1;
            border-left: 5px solid var(--warning);
            color: var(--warning);
        }

        .alert-info {
            background-color: #e5f6ff;
            border-left: 5px solid var(--primary);
            color: var(--secondary);
        }

        /* Code Block Styling for Collapsible Content */
        .code-block {
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 1rem;
            margin-bottom: 2rem;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--dark);
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .code-header button {
            background-color: var(--accent);
            color: var(--dark);
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .code-header button:hover {
            background-color: #ffd700;
        }

        .code-content {
            max-height: 500px; /* Max height before scroll */
            overflow-y: auto;
            transition: max-height 0.3s ease-out;
        }

        .collapsed .code-content {
            max-height: 0;
            overflow: hidden;
            padding: 0;
        }

        .code-content pre {
            margin: 0;
            border: none;
            border-radius: 0;
            background-color: #272822; /* Dark background for code */
            color: #f8f8f2;
            padding: 1rem;
            font-size: 0.85rem;
        }
        
        .flex {
            display: flex;
        }
        
        .space-x-2 > *:not(:first-child) {
            margin-left: 0.5rem;
        }

        footer {
            background-color: var(--dark);
            color: white;
            text-align: center;
            padding: 1rem 0;
            font-size: 0.9rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <h1>TechCity Squad</h1>
            <p>Microsoft 365 Service Desk Automation Solution</p>
        </div>
    </header>

    <nav>
        <div class="container">
            <a href="#overview">Overview</a>
            <a href="#setup">Setup</a>
            <a href="#flows">Flows</a>
            <a href="#appendix-a">Appendix A</a>
            <a href="#appendix-b">Appendix B</a>
            <a href="#next-steps">Next Steps</a>
        </div>
    </nav>

    <div class="container">
        <section id="overview">
            <h2>1. Solution Overview</h2>
            <p>This package provides a complete, automated service desk solution built on the Microsoft 365 stack, primarily utilizing **SharePoint** (for the ticket list) and **Power Automate** (for all workflow logic). It ensures rapid response, transparent communication, and timely follow-up for technical support tickets.</p>

            <h3>Key Components</h3>
            <ul>
                <li><strong>SharePoint List:</strong> The central database for all ticket records (Title, Description, Status, Assigned Tech, Client, etc.).</li>
                <li><strong>Power Automate Flows:</strong> Five automated flows that handle ticket lifecycle, alerts, and feedback.</li>
                <li><strong>Teams Integration:</strong> Used for technician notifications and management alerts.</li>
            </ul>
        </section>

        <section id="setup">
            <h2>2. Initial Setup & Configuration</h2>

            <h3>A. SharePoint Setup</h3>
            <p>Create a SharePoint list named <code>Service Desk Tickets</code>. Ensure the following columns are created with the specified types:</p>
            <ul>
                <li><code>TicketID</code> (Number - *Auto-incrementing ID*)</li>
                <li><code>TicketStatus</code> (Choice - Draft, New, Assigned, In Progress, Resolved, Closed)</li>
                <li><code>AssignedTechnician</code> (Person/Group)</li>
                <li><code>ClientEmail</code> (Single line of text)</li>
                <li><code>Priority</code> (Choice - High, Medium, Low)</li>
                <li><code>LastUpdate</code> (Date and time)</li>
                <li><code>ResolutionNotes</code> (Multiple lines of text)</li>
            </ul>
            <div class="alert alert-warning">
                <strong>CRITICAL:</strong> Ensure **Automated Ticket Creation** is set up (e.g., via a simple Microsoft Form or a monitored mailbox) to populate the initial *Title*, *Description*, and *ClientEmail* fields.
            </div>

            <h3>B. Power Automate Connections</h3>
            <p>The provided flows require connections to the following services:</p>
            <ol>
                <li>SharePoint Online (to read/write ticket data).</li>
                <li>Microsoft Teams (to post alerts).</li>
                <li>Office 365 Users (to get user profiles).</li>
                <li>(For Flow 5) Microsoft Forms or Dataverse (for client feedback).</li>
            </ol>
            <p>When importing the flows in **Appendix B**, you will be prompted to select existing or create new connections for each of these services.</p>
        </section>

        <section id="flows">
            <h2>3. Power Automate Flow Descriptions</h2>
            <p>The solution is driven by five core cloud flows, detailed below and provided in JSON format in **Appendix B** for direct import.</p>

            <ol>
                <li>
                    <h3>Flow 1: New Ticket Assignment (The Triage)</h3>
                    <p><strong>Trigger:</strong> Item created in the SharePoint list.</p>
                    <p><strong>Action:</strong> Sends a notification to the Triage team's Teams channel (or a distribution list) to manually assign the ticket. Updates *TicketStatus* to **New** and *LastUpdate*.</p>
                </li>
                <li>
                    <h3>Flow 2: Technician Assigned Alert</h3>
                    <p><strong>Trigger:</strong> Item modified (when *AssignedTechnician* column is populated or changed).</p>
                    <p><strong>Action:</strong> Sends a direct Teams message to the assigned technician with all ticket details and a link to the item. Updates *TicketStatus* to **Assigned** and *LastUpdate*.</p>
                </li>
                <li>
                    <h3>Flow 3: Stale Ticket Escalation (The Monitor)</h3>
                    <p><strong>Trigger:</strong> Scheduled recurrence (daily, 9:00 AM).</p>
                    <p><strong>Action:</strong> Checks all tickets with *TicketStatus* **Assigned** or **In Progress** where *LastUpdate* is older than 3 business days. Posts a high-priority alert to the Management Team's Teams channel.</p>
                </li>
                <li>
                    <h3>Flow 4: Client Confirmation & Resolution</h3>
                    <p><strong>Trigger:</strong> Item modified (when *TicketStatus* changes to **Resolved**).</p>
                    <p><strong>Action:</strong> Sends an email to the *ClientEmail* with a summary of the resolution (*ResolutionNotes*) and a link to a **Client Feedback Form**. Sets a 7-day timer to automatically change the status to **Closed** if no action is taken by the client.</p>
                </li>
                <li>
                    <h3>Flow 5: Client Feedback Processing</h3>
                    <p><strong>Trigger:</strong> New submission on the Client Feedback Microsoft Form.</p>
                    <p><strong>Action:</strong> Uses the ticket ID included in the form to locate the original SharePoint item. Updates the item with the *FeedbackScore* and *FeedbackComments*. If the score is low (e.g., 3 or less), it posts a separate, immediate alert to the Feedback Management Team's Teams channel.</p>
                </li>
            </ol>
        </section>

        <section id="appendix-a">
            <h2>4. Appendix A: SharePoint List References</h2>
            <p>The following are required placeholder variables used within the Power Automate JSON files. **You must replace these placeholders** (e.g., <code>[[SharePoint_Site_URL]]</code>) with your organization's actual values before activating the flows.</p>
            <ul>
                <li><code>[[SharePoint_Site_URL]]</code>: The URL of the SharePoint site hosting the <code>Service Desk Tickets</code> list.</li>
                <li><code>[[SharePoint_ServiceDesk_List_ID]]</code>: The GUID or list name of the <code>Service Desk Tickets</code> list.</li>
                <li><code>[[Teams_Triage_Team_ID]]</code>: The Group ID of the Teams team used for initial ticket assignment.</li>
                <li><code>[[Teams_Management_Team_ID]]</code>: The Group ID of the Teams team for high-priority escalations.</li>
                <li><code>[[Forms_Feedback_ID]]</code>: The ID of the Microsoft Form used for collecting client satisfaction scores.</li>
                <li><code>[[Teams_Channel_ID_Feedback]]</code>: The Channel ID within the Management Team where low scores are posted.</li>
            </ul>
        </section>

        <section id="appendix-b">
            <h2>5. Appendix B: Power Automate Flow JSON</h2>
            <p>Use the **Export JSON** button next to each flow to download the complete definition file, ready for import into Power Automate.</p>

            <!-- Flow 1 -->
            <h3>Flow 1: New Ticket Assignment (The Triage)</h3>
            <div class="code-block collapsed" id="flow-1">
                <div class="code-header">
                    <div class="flex space-x-2">
                        <button onclick="copyCode('flow-1-code')">Copy Code</button>
                        <button onclick="exportCode('flow-1-code', 'Flow_01-NewTicketAssignment')">Export JSON</button>
                    </div>
                    <button onclick="toggleCollapse('flow-1')">Toggle JSON</button>
                </div>
                <div class="code-content">
                    <pre id="flow-1-code">
{
  "properties": {
    "displayName": "1. New Ticket Assignment (Triage)",
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": { "defaultValue": {}, "type": "Object" }
      },
      "triggers": {
        "When_an_item_is_created": {
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "GetOnNewItems", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        }
      },
      "actions": {
        "Update_item_Status": {
          "runAfter": {},
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "UpdateItem", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]",
              "id": "@triggerBody()?['ID']",
              "item/TicketStatus": "New",
              "item/LastUpdate": "@utcNow()"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        },
        "Post_Triage_Alert_to_Teams": {
          "runAfter": { "Update_item_Status": ["Succeeded"] },
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_teams", "operationId": "PostMessage", "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams" },
            "parameters": {
              "groupId": "[[Teams_Triage_Team_ID]]",
              "channelId": "[[Teams_Channel_ID_Triage]]",
              "messageBody": "🆕 **New Service Desk Ticket Received** 🆕<br>ID: @triggerBody()?['ID']<br>Title: @triggerBody()?['Title']<br>Client: @triggerBody()?['ClientEmail']<br><br>Please assign a technician promptly.<br><a href='@triggerBody()?['{Link}']'>Open Ticket in SharePoint</a>"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        }
      }
    }
  }
}
</pre>
                </div>
            </div>

            <!-- Flow 2 -->
            <h3>Flow 2: Technician Assigned Alert</h3>
            <div class="code-block collapsed" id="flow-2">
                <div class="code-header">
                    <div class="flex space-x-2">
                        <button onclick="copyCode('flow-2-code')">Copy Code</button>
                        <button onclick="exportCode('flow-2-code', 'Flow_02-TechnicianAssignedAlert')">Export JSON</button>
                    </div>
                    <button onclick="toggleCollapse('flow-2')">Toggle JSON</button>
                </div>
                <div class="code-content">
                    <pre id="flow-2-code">
{
  "properties": {
    "displayName": "2. Technician Assigned Alert",
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": { "defaultValue": {}, "type": "Object" }
      },
      "triggers": {
        "When_an_item_is_modified": {
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "GetOnUpdateItems", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        }
      },
      "actions": {
        "Filter_by_Technician_Change": {
          "type": "If",
          "expression": "@not(equals(triggerOutputs()?['body/AssignedTechnician/Email'], triggerOutputs()?['body/AssignedTechnician/Email@odata.old']))",
          "actions": {
            "Update_item_Status": {
              "type": "ApiConnection",
              "inputs": {
                "host": { "connectionName": "shared_sharepointonline", "operationId": "UpdateItem", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
                "parameters": {
                  "siteAddress": "[[SharePoint_Site_URL]]",
                  "listName": "[[SharePoint_ServiceDesk_List_ID]]",
                  "id": "@triggerBody()?['ID']",
                  "item/TicketStatus": "Assigned",
                  "item/LastUpdate": "@utcNow()"
                },
                "authentication": { "type": "ManagedServiceIdentity" }
              }
            },
            "Post_Teams_Message_to_Technician": {
              "runAfter": { "Update_item_Status": ["Succeeded"] },
              "type": "ApiConnection",
              "inputs": {
                "host": { "connectionName": "shared_teams", "operationId": "PostMessage", "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams" },
                "parameters": {
                  "messageBody": "🚨 **New Ticket Assigned** 🚨<br>Ticket ID: @triggerBody()?['ID']<br>Title: @triggerBody()?['Title']<br>Priority: @triggerBody()?['Priority/Value']<br><br>Please begin work on this ticket.<br><a href='@triggerBody()?['{Link}']'>Open Ticket in SharePoint</a>",
                  "recipient": "@triggerBody()?['AssignedTechnician/Email']"
                },
                "authentication": { "type": "ManagedServiceIdentity" }
              }
            }
          }
        }
      }
    }
  }
}
</pre>
                </div>
            </div>

            <!-- Flow 3 -->
            <h3>Flow 3: Stale Ticket Escalation (The Monitor)</h3>
            <div class="code-block collapsed" id="flow-3">
                <div class="code-header">
                    <div class="flex space-x-2">
                        <button onclick="copyCode('flow-3-code')">Copy Code</button>
                        <button onclick="exportCode('flow-3-code', 'Flow_03-StaleTicketEscalation')">Export JSON</button>
                    </div>
                    <button onclick="toggleCollapse('flow-3')">Toggle JSON</button>
                </div>
                <div class="code-content">
                    <pre id="flow-3-code">
{
  "properties": {
    "displayName": "3. Stale Ticket Escalation (Monitor)",
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": { "defaultValue": {}, "type": "Object" }
      },
      "triggers": {
        "Recurrence": {
          "type": "Recurrence",
          "recurrence": { "frequency": "Day", "interval": 1, "startTime": "2024-01-01T09:00:00Z" }
        }
      },
      "actions": {
        "Get_items": {
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "GetItems", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]",
              "filterQuery": "TicketStatus ne 'Resolved' and TicketStatus ne 'Closed' and TicketStatus ne 'New'",
              "top": 2000
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        },
        "Filter_Stale_Tickets": {
          "runAfter": { "Get_items": ["Succeeded"] },
          "type": "FilterArray",
          "inputs": {
            "from": "@body('Get_items')?['value']",
            "where": "@less(item()?['LastUpdate'], subtractFromTime(utcNow(), 3, 'Day'))"
          }
        },
        "Check_for_Stale_Tickets": {
          "runAfter": { "Filter_Stale_Tickets": ["Succeeded"] },
          "type": "If",
          "expression": "@greater(length(body('Filter_Stale_Tickets')), 0)",
          "actions": {
            "Create_HTML_Table": {
              "type": "HtmlTable",
              "inputs": {
                "from": "@body('Filter_Stale_Tickets')",
                "columns": [
                  { "header": "ID", "value": "@item()?['ID']" },
                  { "header": "Title", "value": "@item()?['Title']" },
                  { "header": "Status", "value": "@item()?['TicketStatus']" },
                  { "header": "Last Update", "value": "@formatDateTime(item()?['LastUpdate'], 'MM/dd/yyyy')" },
                  { "header": "Technician", "value": "@item()?['AssignedTechnician']?['DisplayName']" }
                ]
              }
            },
            "Post_Escalation_to_Management_Teams": {
              "runAfter": { "Create_HTML_Table": ["Succeeded"] },
              "type": "ApiConnection",
              "inputs": {
                "host": { "connectionName": "shared_teams", "operationId": "PostMessage", "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams" },
                "parameters": {
                  "groupId": "[[Teams_Management_Team_ID]]",
                  "channelId": "[[Teams_Channel_ID_Escalations]]",
                  "messageBody": "⚠️ **URGENT: Stale Tickets Detected** ⚠️<br>The following @{length(body('Filter_Stale_Tickets'))} tickets have not been updated in 3 or more business days. Immediate review is required.<br>@{body('Create_HTML_Table')}"
                },
                "authentication": { "type": "ManagedServiceIdentity" }
              }
            }
          }
        }
      }
    }
  }
}
</pre>
                </div>
            </div>

            <!-- Flow 4 -->
            <h3>Flow 4: Client Confirmation & Resolution</h3>
            <div class="code-block collapsed" id="flow-4">
                <div class="code-header">
                    <div class="flex space-x-2">
                        <button onclick="copyCode('flow-4-code')">Copy Code</button>
                        <button onclick="exportCode('flow-4-code', 'Flow_04-ClientConfirmationResolution')">Export JSON</button>
                    </div>
                    <button onclick="toggleCollapse('flow-4')">Toggle JSON</button>
                </div>
                <div class="code-content">
                    <pre id="flow-4-code">
{
  "properties": {
    "displayName": "4. Client Confirmation & Resolution",
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": { "defaultValue": {}, "type": "Object" }
      },
      "triggers": {
        "When_an_item_is_modified": {
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "GetOnUpdateItems", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        }
      },
      "actions": {
        "Filter_by_Status_Resolved": {
          "type": "If",
          "expression": "@and(equals(triggerOutputs()?['body/TicketStatus/Value'], 'Resolved'), not(equals(triggerOutputs()?['body/TicketStatus/Value'], triggerOutputs()?['body/TicketStatus/Value@odata.old'])))",
          "actions": {
            "Send_Resolution_Email": {
              "type": "ApiConnection",
              "inputs": {
                "host": { "connectionName": "shared_office365", "operationId": "SendEmailV2", "apiId": "/providers/Microsoft.PowerApps/apis/shared_office365" },
                "parameters": {
                  "To": "@triggerBody()?['ClientEmail']",
                  "Subject": "Ticket Resolved: @triggerBody()?['Title'] (ID: @triggerBody()?['ID'])",
                  "Body": "Dear Client,<br><br>Your ticket has been resolved by our team with the following notes:<br><br><strong>Resolution:</strong> @triggerBody()?['ResolutionNotes']<br><br>If the issue is resolved, please take a moment to provide feedback here: <a href='[[Forms_Feedback_Link]]?ticket=@triggerBody()?['ID']]'>Submit Feedback</a><br><br>This ticket will automatically close in 7 days. If you reply to this email, the ticket will be reopened.<br><br>Thank you,<br>TechCity Support"
                },
                "authentication": { "type": "ManagedServiceIdentity" }
              }
            },
            "Delay_for_7_Days": {
              "runAfter": { "Send_Resolution_Email": ["Succeeded"] },
              "type": "Delay",
              "inputs": { "interval": 7, "unit": "Day" }
            },
            "Get_Current_Ticket_Status": {
                "runAfter": { "Delay_for_7_Days": ["Succeeded"] },
                "type": "ApiConnection",
                "inputs": {
                    "host": { "connectionName": "shared_sharepointonline", "operationId": "GetItem", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
                    "parameters": {
                        "siteAddress": "[[SharePoint_Site_URL]]",
                        "listName": "[[SharePoint_ServiceDesk_List_ID]]",
                        "id": "@triggerBody()?['ID']"
                    },
                    "authentication": { "type": "ManagedServiceIdentity" }
                }
            },
            "Check_If_Still_Resolved": {
                "runAfter": { "Get_Current_Ticket_Status": ["Succeeded"] },
                "type": "If",
                "expression": "@equals(body('Get_Current_Ticket_Status')?['TicketStatus']?['Value'], 'Resolved')",
                "actions": {
                    "Auto_Close_Ticket": {
                        "type": "ApiConnection",
                        "inputs": {
                            "host": { "connectionName": "shared_sharepointonline", "operationId": "UpdateItem", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
                            "parameters": {
                                "siteAddress": "[[SharePoint_Site_URL]]",
                                "listName": "[[SharePoint_ServiceDesk_List_ID]]",
                                "id": "@triggerBody()?['ID']",
                                "item/TicketStatus": "Closed",
                                "item/LastUpdate": "@utcNow()"
                            },
                            "authentication": { "type": "ManagedServiceIdentity" }
                        }
                    }
                }
            }
          }
        }
      }
    }
  }
}
</pre>
                </div>
            </div>
            
            <!-- Flow 5 -->
            <h3>Flow 5: Client Feedback Processing</h3>
            <div class="code-block collapsed" id="flow-5">
                <div class="code-header">
                    <div class="flex space-x-2">
                        <button onclick="copyCode('flow-5-code')">Copy Code</button>
                        <button onclick="exportCode('flow-5-code', 'Flow_05-ClientFeedbackProcessing')">Export JSON</button>
                    </div>
                    <button onclick="toggleCollapse('flow-5')">Toggle JSON</button>
                </div>
                <div class="code-content">
                    <pre id="flow-5-code">
{
  "properties": {
    "displayName": "5. Client Feedback Processing",
    "definition": {
      "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
      "contentVersion": "1.0.0.0",
      "parameters": {
        "$connections": { "defaultValue": {}, "type": "Object" }
      },
      "triggers": {
        "When_a_new_response_is_submitted": {
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_microsoftforms", "operationId": "GetNewFormResponse", "apiId": "/providers/Microsoft.PowerApps/apis/shared_microsoftforms" },
            "parameters": { "formId": "[[Forms_Feedback_ID]]" },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        }
      },
      "actions": {
        "Get_response_details": {
          "runAfter": {},
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_microsoftforms", "operationId": "GetResponseDetails", "apiId": "/providers/Microsoft.PowerApps/apis/shared_microsoftforms" },
            "parameters": { "formId": "[[Forms_Feedback_ID]]", "responseId": "@triggerBody()?['resourceData']?['responseId']" },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        },
        "Extract_Ticket_ID": {
          "runAfter": { "Get_response_details": ["Succeeded"] },
          "type": "Compose",
          "inputs": "@coalesce(outputs('Get_response_details')?['body/r7ccb2875f53245598692794101684c17'], '1')" 
          /* NOTE: Assumes a Forms question field (ID: r7ccb2875f53245598692794101684c17) is hidden/pre-populated with the Ticket ID, or defaults to 1 if not found. Adjust ID to your Forms structure. */
        },
        "Update_SharePoint_Item": {
          "runAfter": { "Extract_Ticket_ID": ["Succeeded"] },
          "type": "ApiConnection",
          "inputs": {
            "host": { "connectionName": "shared_sharepointonline", "operationId": "UpdateItem", "apiId": "/providers/Microsoft.PowerApps/apis/shared_sharepointonline" },
            "parameters": {
              "siteAddress": "[[SharePoint_Site_URL]]",
              "listName": "[[SharePoint_ServiceDesk_List_ID]]",
              "id": "@outputs('Extract_Ticket_ID')",
              "item/FeedbackScore": "@outputs('Get_response_details')?['body/r5d1b54a0f4434190b4d4b31a1964f434']",
              "item/FeedbackComments": "@outputs('Get_response_details')?['body/r1652702755e34b7f941160a221f73752']",
              "item/LastUpdate": "@utcNow()"
            },
            "authentication": { "type": "ManagedServiceIdentity" }
          }
        },
        "Conditional_Alert_Low_Score": {
          "runAfter": { "Update_SharePoint_Item": ["Succeeded"] },
          "type": "If",
          "expression": "@less(int(outputs('Get_response_details')?['body/r5d1b54a0f4434190b4d4b31a1964f434']), 4)",
          "actions": {
            "Post_Low_Score_to_Teams": {
              "type": "ApiConnection",
              "inputs": {
                "host": { "connectionName": "shared_teams", "operationId": "PostMessage", "apiId": "/providers/Microsoft.PowerApps/apis/shared_teams" },
                "parameters": {
                  "groupId": "[[Teams_Management_Team_ID]]",
                  "channelId": "[[Teams_Channel_ID_Feedback]]",
                  "messageBody": "🚨 **URGENT Low Feedback Score Received** 🚨<br>Ticket ID: @outputs('Extract_Ticket_ID')<br>Score: @outputs('Get_response_details')?['body/r5d1b54a0f4434190b4d4b31a1964f434']<br>Comments: @outputs('Get_response_details')?['body/r1652702755e34b7f941160a221f73752']"
                },
                "authentication": { "type": "ManagedServiceIdentity" }
              }
            }
          }
        }
      }
    }
  }
}
</pre>
                </div>
            </div>
            
        </section>

        <section id="next-steps">
            <h2>6. Next Steps & Deployment</h2>
            <p>Your solution blueprint is now complete! Follow these final steps to deploy:</p>
            <ol>
                <li>Complete the SharePoint list setup (Section 2A).</li>
                <li>Download all five JSON flow files using the **Export JSON** buttons in **Appendix B**.</li>
                <li>In Power Automate, use the **Import** feature for each JSON file.</li>
                <li>Update all the placeholder variables (the <code>[[...]]</code> values) in the imported flows with your real **SharePoint URLs, List IDs, and Teams Group IDs** (Appendix A).</li>
                <li>Activate all five flows.</li>
                <li>Monitor automations for the first 48 hours.</li>
            </ol>
        </section>
    </div>

    <footer>
        <div class="container">
            <p>TechCity Squad – Microsoft 365 Service Desk Solution</p>
            <p>Complete Implementation Package v2.1</p>
        </div>
    </footer>

    <script>
        // Global utility function to toggle the collapsed state of a code block
        function toggleCollapse(blockId) {
            const block = document.getElementById(blockId);
            block.classList.toggle('collapsed');
        }

        // Function to copy code to the clipboard
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const textArea = document.createElement('textarea');
            // Use textContent to grab the raw JSON, including whitespace
            textArea.value = codeElement.textContent.trim();
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }
        
        // Function to export code as a downloadable .json file
        function exportCode(elementId, fileName) {
            const codeElement = document.getElementById(elementId);
            // Get content and remove leading/trailing whitespace
            const content = codeElement.textContent.trim(); 
            
            // Create a Blob from the JSON string
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary anchor element and trigger the download
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName.endsWith('.json') ? fileName : fileName + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Clean up the URL object
            URL.revokeObjectURL(url);

            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Exporting...';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }

        // Add smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
        
        // Collapse all code blocks on load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.code-block').forEach(block => {
                if (!block.classList.contains('collapsed')) {
                    block.classList.add('collapsed');
                }
            });
        });
    </script>
</body>
</html>
